<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Cross-Verified Admin</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 24px;
      background: #f5f7fb;
    }
    h1, h2 {
      margin: 0 0 12px;
    }
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #e1e4eb;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background: #f0f2f8;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 11px;
      background: #e5f0ff;
      color: #2851a3;
    }

    /* ✅ 추가: 긴 텍스트/JSON 보기 좋게 */
    pre.wrap {
      white-space: pre-wrap;
      word-break: break-word;
      margin: 8px 0 0;
      font-size: 12px;
      line-height: 1.35;
      background: #fafbff;
      border: 1px solid #e7eaf3;
      border-radius: 10px;
      padding: 10px 12px;
    }
    details {
      margin-top: 10px;
    }
    summary {
      cursor: pointer;
      user-select: none;
      font-weight: 600;
    }
    .muted {
      color: #555;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Cross-Verified Admin</h1>
      <p>
        로그인: 
        <% if (user) { %>
          <strong><%= user.name %></strong> &lt;<%= user.email %>&gt;
        <% } else { %>
          (알 수 없음)
        <% } %>
      </p>
      <p>
        Region: <span class="tag"><%= region %></span> ·
        HTTP Timeout: <%= httpTimeoutMs %> ms
      </p>
    </div>

    <div class="card">
      <h2>엔진 통계 (engine_stats)</h2>
      <% if (engineStats && engineStats.length) { %>
        <table>
          <thead>
            <tr>
              <th>엔진</th>
              <th>avg_truth</th>
              <th>avg_response(ms)</th>
              <th>window</th>
              <th>sample_count</th>
              <th>total_runs</th>
              <th>auto_ce</th>
              <th>override_ce</th>
              <th>effective_ce</th>
              <th>updated_at</th>
            </tr>
          </thead>
          <tbody>
            <% engineStats.forEach(function(row) { %>
              <tr>
                <td><strong><%= row.engine_name %></strong></td>
                <td><%= row.avg_truth %></td>
                <td><%= row.avg_response %></td>
                <td><%= row.rolling_window_size %></td>
                <td><%= row.sample_count %></td>
                <td><%= row.total_runs %></td>
                <td><%= row.auto_ce %></td>
                <td><%= row.override_ce %></td>
                <td><%= row.effective_ce %></td>
                <td><%= row.updated_at %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p>엔진 통계 데이터가 없습니다.</p>
      <% } %>
    </div>

    <!-- ✅ 최근 요청 엔진 메트릭스 -->
    <div class="card">
      <h2>최근 요청 엔진 메트릭스 (engine_metrics)</h2>

      <% const _lastRequest = (typeof lastRequest !== "undefined") ? lastRequest : null; %>
      <% const _m = (typeof lastEngineMetrics !== "undefined") ? lastEngineMetrics : null; %>
      <% const _t = (typeof lastEngineTimes !== "undefined") ? lastEngineTimes : null; %>

      <% if (_lastRequest) { %>
        <p style="margin:0 0 8px; font-size:13px; color:#333;">
          <span class="tag"><%= _lastRequest.mode %></span>
          · truthscore: <%= _lastRequest.truthscore %>
          · elapsed: <%= _lastRequest.elapsed %> ms
          · model: <%= _lastRequest.gemini_model %>
          <br/>
          query: <strong><%= _lastRequest.query %></strong>
          <br/>
          at: <%= _lastRequest.created_at %>
        </p>
      <% } else { %>
        <p>최근 요청 로그가 없습니다.</p>
      <% } %>

      <% 
        const names = new Set();
        if (_m) Object.keys(_m).forEach(k => names.add(k));
        if (_t) Object.keys(_t).forEach(k => names.add(k));
        const rows = Array.from(names).sort();
      %>

      <% if (rows.length) { %>
        <table>
          <thead>
            <tr>
              <th>엔진</th>
              <th>calls</th>
              <th>ms_last</th>
              <th>ms_avg</th>
              <th>ms_total</th>
              <th>request_time(ms)</th>
            </tr>
          </thead>
          <tbody>
            <% rows.forEach(function(name) { 
                 const mm = _m ? _m[name] : null;
                 const tt = _t ? _t[name] : null;
            %>
              <tr>
                <td><strong><%= name %></strong></td>
                <td><%= mm && mm.calls != null ? mm.calls : "-" %></td>
                <td><%= mm && mm.ms_last != null ? mm.ms_last : "-" %></td>
                <td><%= mm && mm.ms_avg != null ? mm.ms_avg : "-" %></td>
                <td><%= mm && mm.ms_total != null ? mm.ms_total : "-" %></td>
                <td><%= tt != null ? tt : "-" %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p>최근 engine_metrics/engine_times 데이터가 없습니다. (최근 /api/verify 호출이 없거나 partial_scores 저장이 비어있을 수 있음)</p>
      <% } %>
    </div>

    <!-- ✅ 추가: Gemini 메트릭스/응답 전문 보기 -->
    <div class="card">
      <h2>최근 요청 Gemini 메트릭스 (gemini_metrics)</h2>

      <% const _gm = (typeof lastGeminiMetrics !== "undefined") ? lastGeminiMetrics : null; %>
      <% const _gt = (typeof lastGeminiTimes !== "undefined") ? lastGeminiTimes : null; %>

      <% 
        const ps = (_lastRequest && _lastRequest.partial_scores_obj && typeof _lastRequest.partial_scores_obj === "object")
          ? _lastRequest.partial_scores_obj
          : {};
        const geminiTotal = (ps && ps.gemini_total_ms != null) ? ps.gemini_total_ms : null;

        const gnames = new Set();
        if (_gm) Object.keys(_gm).forEach(k => gnames.add(k));
        if (_gt) Object.keys(_gt).forEach(k => gnames.add(k));
        const grows = Array.from(gnames).sort();
      %>

      <% if (_lastRequest) { %>
        <p class="muted" style="margin:0 0 8px;">
          (같은 최근 요청 기준) gemini_total_ms: <strong><%= geminiTotal != null ? geminiTotal : "-" %></strong>
        </p>
      <% } %>

      <% if (grows.length) { %>
        <table>
          <thead>
            <tr>
              <th>단계</th>
              <th>calls</th>
              <th>ms_last</th>
              <th>ms_avg</th>
              <th>ms_total</th>
              <th>request_time(ms)</th>
            </tr>
          </thead>
          <tbody>
            <% grows.forEach(function(name) { 
                 const mm = _gm ? _gm[name] : null;
                 const tt = _gt ? _gt[name] : null;
            %>
              <tr>
                <td><strong><%= name %></strong></td>
                <td><%= mm && mm.calls != null ? mm.calls : "-" %></td>
                <td><%= mm && mm.ms_last != null ? mm.ms_last : "-" %></td>
                <td><%= mm && mm.ms_avg != null ? mm.ms_avg : "-" %></td>
                <td><%= mm && mm.ms_total != null ? mm.ms_total : "-" %></td>
                <td><%= tt != null ? tt : "-" %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p>최근 gemini_metrics/gemini_times 데이터가 없습니다. (server.js에서 /admin/ui 렌더링 변수 전달 + partial_scores 저장이 필요)</p>
      <% } %>

      <details>
        <summary>Flash Output (FULL)</summary>
        <pre class="wrap"><%= ps && ps.flash_text ? ps.flash_text : "" %></pre>
      </details>

      <details>
        <summary>Verify Output (FULL)</summary>
        <pre class="wrap"><%= ps && ps.verify_text ? ps.verify_text : "" %></pre>
      </details>

      <details>
        <summary>partial_scores (FULL JSON)</summary>
        <pre class="wrap"><%= JSON.stringify(ps || {}, null, 2) %></pre>
      </details>
    </div>

    <div class="card">
      <h2>엔진 통계 · 가중치 & 보정값</h2>
      <% if (engineStats && engineStats.length) { %>
        <table>
          <thead>
            <tr>
              <th>엔진</th>
              <th>avg_truth</th>
              <th>avg_response(ms)</th>
              <th>auto_ce</th>
              <th>override_ce</th>
              <th>effective_ce</th>
              <th>base_weight</th>
              <th>final_weight<br/>(base × eff_ce)</th>
              <th>조정</th>
            </tr>
          </thead>
          <tbody>
            <% engineStats.forEach(function(row) { 
                 const baseW = (baseWeights && baseWeights[row.engine_name]) || 1;
                 const effCe = (row.effective_ce != null 
                                ? row.effective_ce 
                                : (row.auto_ce != null ? row.auto_ce : 1));
                 const finalW = (baseW * effCe).toFixed(3);
            %>
              <tr>
                <td><strong><%= row.engine_name %></strong></td>
                <td><%= row.avg_truth %></td>
                <td><%= row.avg_response %></td>
                <td><%= row.auto_ce %></td>
                <td><%= row.override_ce %></td>
                <td><%= row.effective_ce %></td>
                <td><%= baseW %></td>
                <td><%= finalW %></td>
                <td>
                  <form method="post" action="/admin/engine-stats/override" style="display:flex; gap:4px; align-items:center;">
                    <input type="hidden" name="engine_name" value="<%= row.engine_name %>" />
                    <input
                      type="number"
                      name="override_ce"
                      step="0.01"
                      min="0.5"
                      max="1.5"
                      placeholder="e.g. 1.02"
                      value="<%= (row.override_ce != null ? row.override_ce : '') %>"
                      style="width:80px; padding:2px 4px; font-size:12px;"
                    />
                    <button type="submit" name="action" value="set" style="padding:4px 8px; font-size:12px; border-radius:6px; border:none; cursor:pointer;">
                      저장
                    </button>
                    <button type="submit" name="action" value="clear" style="padding:4px 8px; font-size:12px; border-radius:6px; border:none; cursor:pointer; background:#eee;">
                      초기화
                    </button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
        <p style="margin-top:8px; font-size:12px; color:#555;">
          · <code>auto_ce</code>: 서버가 최근 샘플(TruthScore)로 자동 계산한 보정값 (0.9~1.1) (응답시간은 모니터링용)<br/>
          · <code>override_ce</code>: 관리자가 수동으로 지정한 값 (입력 시 <code>0.5~1.5</code>로 제한, 권장 <code>0.9~1.1</code>)<br/>
          · <code>effective_ce</code>: 실제 사용되는 최종 보정값 (override_ce가 있으면 그 값, 없으면 auto_ce)<br/>
          · <code>final_weight</code>: 각 엔진이 TruthScore 계산에 반영되는 최종 가중치 = base_weight × effective_ce
        </p>
      <% } else { %>
        <p>엔진 통계 데이터가 없습니다.</p>
      <% } %>
    </div>
  </div>
</body>
</html>
