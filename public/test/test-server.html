<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cross-Verified AI Proxy Live Console v10.4</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #f7fafc; font-family: 'Segoe UI', sans-serif; }
    textarea, input { border-radius: 6px; padding: 6px; width: 100%; }
    .section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.08); margin-bottom: 20px; }
    pre { background: #1e1e1e; color: #00ffcc; padding: 10px; border-radius: 6px; overflow-x: auto; font-size: 0.85rem; }
    .badge { display: inline-block; padding: 3px 8px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; }
    .green { background-color: #d1fae5; color: #065f46; }
    .yellow { background-color: #fef9c3; color: #92400e; }
    .red { background-color: #fee2e2; color: #991b1b; }
  </style>
</head>
<body class="p-6">
  <h1 class="text-2xl font-bold mb-4 text-blue-700">ğŸš€ Cross-Verified AI Proxy Live Console v10.4</h1>

  <!-- ğŸŸ¢ ì„œë²„ ìƒíƒœ íŒ¨ë„ -->
  <div class="section">
    <h2 class="text-xl font-semibold mb-2">ğŸ“¡ ì‹¤ì‹œê°„ ì„œë²„ ìƒíƒœ</h2>
    <div id="serverStatus" class="font-mono text-gray-700">
      ìƒíƒœ: <span id="healthBadge" class="badge yellow">í™•ì¸ ì¤‘...</span>  
      <br/>ë²„ì „: <span id="serverVersion">-</span>  
      <br/>ì‘ë‹µì‹œê°„: <span id="pingTime">-</span> ms
    </div>
    <button class="bg-blue-600 text-white px-3 py-2 rounded mt-2" onclick="manualPing()">ğŸ”„ ìˆ˜ë™ Ping</button>
    <pre id="pingLog" class="mt-3"></pre>
  </div>

  <!-- ğŸ”‘ Key ì„¤ì • -->
  <div class="section">
    <h2 class="text-xl font-semibold mb-2">ğŸ”‘ API Key ì„¤ì • ë° ìƒíƒœ</h2>
    <textarea id="geminiKeys" rows="3" placeholder="Gemini Key (ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ê°œ)"></textarea>
    <div class="text-sm mt-1">í˜„ì¬ í™œì„± í‚¤: <span id="activeKey">-</span></div>
    <div class="flex flex-wrap gap-2 mt-2">
      <button class="bg-blue-600 text-white px-3 py-2 rounded" onclick="saveKeys()">ğŸ’¾ ì €ì¥</button>
      <button class="bg-gray-600 text-white px-3 py-2 rounded" onclick="loadKeys()">ğŸ”„ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="bg-red-600 text-white px-3 py-2 rounded" onclick="clearKeys()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
      <button class="bg-green-600 text-white px-3 py-2 rounded" onclick="validateKeys()">ğŸ” ìœ íš¨ì„± ê²€ì‚¬</button>
    </div>
    <pre id="keyCheckOutput" class="mt-3"></pre>
  </div>

  <!-- ğŸ¤– Gemini í…ŒìŠ¤íŠ¸ -->
  <div class="section">
    <h2 class="text-xl font-semibold mb-2">ğŸ¤– Gemini í…ŒìŠ¤íŠ¸ (Fail-Grace íšŒì „)</h2>
    <textarea id="geminiPrompt" rows="2" placeholder="ì˜ˆ: ì˜¤ëŠ˜ ì„œìš¸ ë‚ ì”¨ ì–´ë•Œìš”?"></textarea>
    <button class="bg-green-600 text-white px-4 py-2 rounded mt-2" onclick="testGemini()">Gemini í˜¸ì¶œ</button>
    <pre id="geminiOutput" class="mt-3"></pre>
  </div>

  <!-- âš–ï¸ ë³‘ë ¬ ê²€ì¦ -->
  <div class="section">
    <h2 class="text-xl font-semibold mb-2">âš–ï¸ ë‹¤ì¤‘ ì—”ì§„ ê²€ì¦ (/api/verify/all)</h2>
    <textarea id="queryInput" rows="2" placeholder="ì˜ˆ: UAM national strategy"></textarea>
    <button class="bg-purple-600 text-white px-4 py-2 rounded mt-2" onclick="runVerifyAll()">ê²€ì¦ ì‹¤í–‰</button>
    <pre id="verifyOutput" class="mt-3"></pre>
  </div>

  <!-- ğŸ“ˆ TruthScore ê³„ì‚° -->
  <div class="section">
    <h2 class="text-xl font-semibold mb-2">ğŸ“ˆ TruthScore ê³„ì‚°ê¸°</h2>
    <div id="truthInputs" class="grid grid-cols-3 gap-2 mb-2">
      <input id="crossref" placeholder="CrossRef" />
      <input id="openalex" placeholder="OpenAlex" />
      <input id="gdelt" placeholder="GDELT" />
      <input id="wikidata" placeholder="Wikidata" />
      <input id="github" placeholder="GitHub" />
      <input id="naver" placeholder="Naver" />
    </div>
    <button class="bg-indigo-600 text-white px-4 py-2 rounded" onclick="calculateTruthScore()">TruthScore ê³„ì‚°</button>
    <pre id="truthOutput" class="mt-3"></pre>
  </div>

  <!-- ğŸ“œ ì‹¤ì‹œê°„ ë¡œê·¸ -->
  <div class="section">
    <h2 class="text-xl font-semibold mb-2">ğŸ“œ ì‹¤ì‹œê°„ ë¡œê·¸ ëª¨ë‹ˆí„°</h2>
    <pre id="liveLog" style="max-height: 200px; overflow-y: scroll;"></pre>
  </div>

  <script>
    const API_BASE = "https://cross-verified-ai-proxy.onrender.com";
    let keyIndex = 0, failCount = 0;
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    const log = msg => {
      const box = document.getElementById("liveLog");
      box.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      box.scrollTop = box.scrollHeight;
    };

    async function checkServerHealth(auto = false) {
      const badge = document.getElementById("healthBadge");
      const version = document.getElementById("serverVersion");
      const pingBox = document.getElementById("pingTime");
      const start = performance.now();
      try {
        const res = await fetch(`${API_BASE}/health`);
        const data = await res.json();
        const elapsed = Math.round(performance.now() - start);
        pingBox.textContent = elapsed;
        version.textContent = data.version;
        badge.textContent = "ğŸŸ¢ ì •ìƒ";
        badge.className = "badge green";
        if (!auto) log(`âœ… ì„œë²„ ì‘ë‹µ ${elapsed}ms`);
      } catch {
        badge.textContent = "ğŸ”´ ì˜¤ë¥˜";
        badge.className = "badge red";
        if (!auto) log("âŒ ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨");
      }
    }

    function manualPing() { checkServerHealth(false); }

    setInterval(() => checkServerHealth(true), 30000);
    checkServerHealth(true);

    function getKeys() {
      return {
        geminiKeys: document.getElementById("geminiKeys").value.split("\n").filter(v => v.trim() !== ""),
        githubToken: document.getElementById("githubToken")?.value.trim(),
        klawUserId: document.getElementById("klawUserId")?.value.trim(),
        naverClientId: document.getElementById("naverClientId")?.value.trim(),
        naverClientSecret: document.getElementById("naverClientSecret")?.value.trim()
      };
    }

    function saveKeys() {
      localStorage.setItem("crossVerifiedKeys", JSON.stringify(getKeys()));
      log("ğŸ’¾ Key ì €ì¥ ì™„ë£Œ");
    }
    function loadKeys() {
      const data = localStorage.getItem("crossVerifiedKeys");
      if (data) {
        const keys = JSON.parse(data);
        document.getElementById("geminiKeys").value = (keys.geminiKeys || []).join("\n");
        document.getElementById("githubToken").value = keys.githubToken || "";
        document.getElementById("klawUserId").value = keys.klawUserId || "";
        document.getElementById("naverClientId").value = keys.naverClientId || "";
        document.getElementById("naverClientSecret").value = keys.naverClientSecret || "";
        log("ğŸ”„ Key ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
      }
    }
    function clearKeys() { localStorage.removeItem("crossVerifiedKeys"); log("ğŸ—‘ï¸ Key ì´ˆê¸°í™” ì™„ë£Œ"); }

    // ğŸ” Key ìœ íš¨ì„± ê²€ì‚¬
    async function validateKeys() {
      const keys = getKeys().geminiKeys;
      const out = document.getElementById("keyCheckOutput");
      out.textContent = "ê²€ì‚¬ ì¤‘...";
      log("ğŸ” Gemini Key ìœ íš¨ì„± ê²€ì‚¬ ì‹œì‘");
      let results = [];

      for (let k of keys) {
        try {
          const res = await fetch(`${API_BASE}/api/gemini/generate`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ apiKey: k, model: "gemini-2.5-flash", prompt: "ping" })
          });
          const data = await res.json();
          results.push(`${data.success ? "ğŸŸ¢" : "ğŸ”´"} ${k.slice(0, 12)}...`);
          log(`ğŸ”‘ ${k.slice(0, 12)}... â†’ ${data.success ? "ì •ìƒ" : "ì˜¤ë¥˜"}`);
        } catch { results.push(`ğŸ”´ ${k.slice(0, 12)}...`); }
        await sleep(250);
      }
      out.textContent = results.join("\n");
    }

    // ğŸ¤– Fail-Grace íšŒì „
    async function callGeminiWithRotation(prompt) {
      const keys = getKeys().geminiKeys;
      const key = keys[keyIndex];
      document.getElementById("activeKey").textContent = `#${keyIndex+1} (${key.slice(0,8)}...)`;
      try {
        const res = await fetch(`${API_BASE}/api/gemini/generate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ apiKey: key, model: "gemini-2.5-flash", prompt })
        });
        const data = await res.json();
        if (data.success) { log(`âœ… Gemini Key #${keyIndex+1} ì„±ê³µ`); failCount = 0; return data; }
        throw new Error(data.error);
      } catch (err) {
        failCount++; log(`âš ï¸ Key #${keyIndex+1} ì‹¤íŒ¨ â†’ íšŒì „`);
        keyIndex = (keyIndex + 1) % keys.length;
        if (failCount >= keys.length) throw new Error("ëª¨ë“  í‚¤ ì‹¤íŒ¨ (Fail-Hard)");
        await sleep(400);
        return callGeminiWithRotation(prompt);
      }
    }

    async function testGemini() {
      const prompt = document.getElementById("geminiPrompt").value.trim();
      const out = document.getElementById("geminiOutput");
      out.textContent = "â³ ìš”ì²­ ì¤‘...";
      try {
        const res = await callGeminiWithRotation(prompt);
        out.textContent = JSON.stringify(res, null, 2);
      } catch (err) { out.textContent = `âŒ ${err.message}`; log(err.message); }
    }

    async function runVerifyAll() {
      const query = document.getElementById("queryInput").value.trim();
      const out = document.getElementById("verifyOutput");
      out.textContent = "ê²€ì¦ ì¤‘...";
      log(`âš–ï¸ Verify All: ${query}`);
      const res = await fetch(`${API_BASE}/api/verify/all`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query, keys: getKeys() })
      });
      const data = await res.json();
      out.textContent = JSON.stringify(data, null, 2);
      log(`âœ… ê²€ì¦ ì™„ë£Œ (${Object.keys(data.results||{}).length} engines)`);
    }

    async function calculateTruthScore() {
      const scores = ["crossref","openalex","gdelt","wikidata","github","naver"]
        .reduce((acc,id)=>({ ...acc, [id]: parseFloat(document.getElementById(id).value)||0 }),{});
      const res = await fetch(`${API_BASE}/api/truthscore/calculate`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ scores })
      });
      const data = await res.json();
      document.getElementById("truthOutput").textContent = JSON.stringify(data,null,2);
      log(`ğŸ“ˆ TruthScore ê³„ì‚° ì™„ë£Œ`);
    }
  </script>
</body>
</html>
